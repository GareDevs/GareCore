{% extends 'core/base.html' %}
{% load static %}
{% block title %}Árvore de Relacionamentos{% endblock %}

{% block content %}
<div id="arvore" class="section" data-load-function="loadArvoreRelacionamentos">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-project-diagram me-2"></i>Árvore de Relacionamentos</h2>
        </div>
    </div>


    <div class="row mt-4">
        <!-- Painel lateral esquerdo -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Buscar por GOA / Criar Relacionamento</h5>
                </div>
                <div class="card-body">

                    <!-- Busca por GOA -->
                    <div class="mb-4">
                        <label for="busca-goa" class="form-label">
                            <i class="fas fa-search me-1"></i>Buscar Pessoa por GOA
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="busca-goa" placeholder="Ex: GOAINV001, GOADEN002..." style="text-transform: uppercase;">
                            <button class="btn btn-outline-primary" type="button" onclick="buscarPorGOA()">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-success" type="button" onclick="buscarEExpandirPorGOA()" title="Buscar e expandir automaticamente os vínculos">
                                <i class="fas fa-search-plus"></i> Localizar e Expandir
                            </button>
                            <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#prefixos-goa">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <strong>Como usar:</strong> Digite um GOA para encontrar e automaticamente expandir todos os vínculos da pessoa na árvore
                        </div>

                        <!-- Painel de prefixos GOA -->
                        <div class="collapse mt-3" id="prefixos-goa">
                            <div class="card card-body bg-light">
                                <h6><i class="fas fa-tag me-2"></i>Prefixos GOA Disponíveis:</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <small>
                                            <strong>GOAINV</strong> - Investigação<br>
                                            <strong>GOADEN</strong> - Denúncia<br>
                                            <strong>GOACIV</strong> - Processo Civil<br>
                                            <strong>GOACRI</strong> - Processo Criminal<br>
                                            <strong>GOAADM</strong> - Processo Administrativo<br>
                                            <strong>GOAJUD</strong> - Judicial<br>
                                            <strong>GOAEXT</strong> - Extrajudicial<br>
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <small>
                                            <strong>GOATRI</strong> - Tributário<br>
                                            <strong>GOATRA</strong> - Trabalhista<br>
                                            <strong>GOAFAM</strong> - Família<br>
                                            <strong>GOACOM</strong> - Comercial<br>
                                            <strong>GOAIMO</strong> - Imobiliário<br>
                                            <strong>GOACON</strong> - Consumidor<br>
                                            <strong>GOAENV</strong> - Ambiental<br>
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <small>
                                            <strong>GOACOR</strong> - Corporativo<br>
                                            <strong>GOACOM</strong> - Compliance<br>
                                            <strong>GOASEG</strong> - Seguros<br>
                                            <strong>GOAPRE</strong> - Previdenciário<br>
                                            <strong>GOAMED</strong> - Médico<br>
                                            <strong>GOAEDU</strong> - Educacional<br>
                                            <strong>GOATEC</strong> - Tecnologia<br>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="resultado-goa" class="mt-2"></div>
                    </div>

                    <hr>

                    <!-- Busca geral na árvore -->
                    <div class="search-section">
                        <h6><i class="fas fa-search me-2"></i>Buscar Pessoa na Árvore</h6>
                        <div class="mb-3">
                            <label class="form-label">Buscar por Nome, GOA ou Documento</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="busca-arvore" placeholder="Digite nome, GOA, CPF ou CNPJ...">
                                <button class="btn btn-primary" type="button" onclick="buscarPessoaNaArvore()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <strong>Busca inteligente:</strong> Digite qualquer parte do nome, GOA, CPF ou CNPJ.
                            </div>
                        </div>
                        <div id="resultados-busca-arvore" class="mt-3"></div>
                    </div>

                    <hr>

                    <!-- Estatísticas -->
                    <div class="stats-section">
                        <h6><i class="fas fa-chart-bar me-2"></i>Estatísticas da Árvore</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1" id="total-pessoas-arvore">0</h6>
                                        <small>Pessoas</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1" id="total-relacionamentos-arvore">0</h6>
                                        <small>Vínculos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1" id="nos-expandidos">0</h6>
                                        <small>Expandidos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Instruções de uso -->
                    <div class="instructions-section">
                        <h6><i class="fas fa-info-circle me-2"></i>Instruções de Uso</h6>
                        <div class="alert alert-info py-2">
                            <small>
                                <strong>Interações na Árvore:</strong><br>
                                • <strong>Clique simples:</strong> Menu de opções<br>
                                • <strong>Duplo clique:</strong> Expandir/recolher vínculos<br>
                                • <strong>Arrastar:</strong> Mover nó pela tela<br>
                                • <strong>Scroll:</strong> Zoom in/out<br>
                                • <strong>Menu contextual:</strong> Personalizar cores e fotos
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área da árvore (direita) -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Árvore Genealógica Interativa</h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="toggleTelaCheia()" title="Expandir árvore para tela cheia">
                                <i class="fas fa-expand me-1"></i>Tela Cheia
                            </button>
                            <button class="btn btn-sm btn-success" onclick="analisarTodosOsDados()" title="Analisar TODOS os dados e criar relacionamentos automáticos">
                                <i class="fas fa-brain me-1"></i>Análise Completa
                            </button>
                        </div>
                    </div>

                    <!-- Controles essenciais -->
                    <div class="row mb-3">
                        <!-- Espaçamento -->
                        <div class="col-md-6">
                            <label class="form-label small"><i class="fas fa-arrows-alt-h me-1"></i>Espaçamento:</label>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-info" id="diminuir-espaco"><i class="fas fa-compress-alt"></i></button>
                                <input type="range" class="form-range mx-2" id="controle-espacamento" min="50" max="300" value="150">
                                <button class="btn btn-sm btn-outline-info" id="aumentar-espaco"><i class="fas fa-expand-alt"></i></button>
                            </div>
                            <small class="text-muted d-block text-center mt-1"><span id="valor-espacamento">150</span>px</small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-warning" onclick="limparConexoesAutomaticas()">
                                <i class="fas fa-eraser me-1"></i>Limpar Auto
                            </button>
                            <button class="btn btn-outline-danger" onclick="limparTodasConexoes()">
                                <i class="fas fa-trash me-1"></i>Limpar Todas
                            </button>
                            <button class="btn btn-outline-info" onclick="renderizarArvoreInterativa()">
                                <i class="fas fa-refresh me-1"></i>Atualizar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div id="arvore-container" style="height: 600px; border: 1px solid #ddd; border-radius: 5px;">
                        <!-- A árvore interativa será renderizada aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ===== FASE 1: Novos módulos refatorados ===== -->

<!-- 1. API Cliente - consolidar todas as chamadas API -->
<script src="{% static 'core/js/api-relacionamentos.js' %}"></script>

<!-- 2. Lógica de Negócio - gerenciar estado e operações -->
<script src="{% static 'core/js/arvore-logica.js' %}"></script>

<!-- 3. Renderização D3 - apenas visualização -->
<script src="{% static 'core/js/arvore-d3-render.js' %}"></script>

<!-- 4. Orquestradora Principal - integrar tudo -->
<script src="{% static 'core/js/arvore-app.js' %}"></script>

<!-- ===== Testes de Integração ===== -->
<script src="{% static 'core/js/teste-integracao.js' %}"></script>

<!-- ===== Módulos auxiliares ===== -->

<!-- Manipulação visual de vínculos (mantém funcionalidade) -->
<script src="{% static 'core/js/vinculos-avancados.js' %}"></script>

<!-- Scripts antigos (mantidos por compatibilidade durante transição) -->
<!-- <script src="{% static 'core/js/arvore.js' %}"></script> -->
<!-- <script src="{% static 'core/js/arvore-interativa.js' %}"></script> -->

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Mostrar esta seção quando acessada diretamente
        const section = document.getElementById('arvore');
        if (section) {
            section.style.display = 'block';
        }
        
        // Inicializar árvore usando novo sistema
        loadArvoreRelacionamentos();
    });
</script>
{% endblock %}