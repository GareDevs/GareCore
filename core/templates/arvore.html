{% extends 'core/base.html' %}
{% load static %}
{% block title %}√Årvore de Relacionamentos{% endblock %}

{% block content %}
<div id="arvore" class="section" data-load-function="loadArvoreRelacionamentos">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-project-diagram me-2"></i>√Årvore de Relacionamentos</h2>
        </div>
    </div>


    <div class="row mt-4">
        <!-- Painel lateral esquerdo -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Buscar por GOA / Criar Relacionamento</h5>
                </div>
                <div class="card-body">

                    <!-- Busca por GOA -->
                    <div class="mb-4">
                        <label for="busca-goa" class="form-label">
                            <i class="fas fa-search me-1"></i>Buscar Pessoa por GOA
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="busca-goa" placeholder="Ex: GOAINV001, GOADEN002..." style="text-transform: uppercase;">
                            <button class="btn btn-outline-primary" type="button" onclick="buscarPorGOA()">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-success" type="button" onclick="buscarEExpandirPorGOA()" title="Buscar e expandir automaticamente os v√≠nculos">
                                <i class="fas fa-search-plus"></i> Localizar e Expandir
                            </button>
                            <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#prefixos-goa">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <strong>Como usar:</strong> Digite um GOA para encontrar e automaticamente expandir todos os v√≠nculos da pessoa na √°rvore
                        </div>

                        <!-- Painel de prefixos GOA -->
                        <div class="collapse mt-3" id="prefixos-goa">
                            <div class="card card-body bg-light">
                                <h6><i class="fas fa-tag me-2"></i>Prefixos GOA Dispon√≠veis:</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <small>
                                            <strong>GOAINV</strong> - Investiga√ß√£o<br>
                                            <strong>GOADEN</strong> - Den√∫ncia<br>
                                            <strong>GOACIV</strong> - Processo Civil<br>
                                            <strong>GOACRI</strong> - Processo Criminal<br>
                                            <strong>GOAADM</strong> - Processo Administrativo<br>
                                            <strong>GOAJUD</strong> - Judicial<br>
                                            <strong>GOAEXT</strong> - Extrajudicial<br>
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <small>
                                            <strong>GOATRI</strong> - Tribut√°rio<br>
                                            <strong>GOATRA</strong> - Trabalhista<br>
                                            <strong>GOAFAM</strong> - Fam√≠lia<br>
                                            <strong>GOACOM</strong> - Comercial<br>
                                            <strong>GOAIMO</strong> - Imobili√°rio<br>
                                            <strong>GOACON</strong> - Consumidor<br>
                                            <strong>GOAENV</strong> - Ambiental<br>
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <small>
                                            <strong>GOACOR</strong> - Corporativo<br>
                                            <strong>GOACOM</strong> - Compliance<br>
                                            <strong>GOASEG</strong> - Seguros<br>
                                            <strong>GOAPRE</strong> - Previdenci√°rio<br>
                                            <strong>GOAMED</strong> - M√©dico<br>
                                            <strong>GOAEDU</strong> - Educacional<br>
                                            <strong>GOATEC</strong> - Tecnologia<br>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="resultado-goa" class="mt-2"></div>
                    </div>

                    <hr>

                    <!-- Busca geral na √°rvore -->
                    <div class="search-section">
                        <h6><i class="fas fa-search me-2"></i>Buscar Pessoa na √Årvore</h6>
                        <div class="mb-3">
                            <label class="form-label">Buscar por Nome, GOA ou Documento</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="busca-arvore" placeholder="Digite nome, GOA, CPF ou CNPJ...">
                                <button class="btn btn-primary" type="button" onclick="buscarPessoaNaArvore()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <strong>Busca inteligente:</strong> Digite qualquer parte do nome, GOA, CPF ou CNPJ.
                            </div>
                        </div>
                        <div id="resultados-busca-arvore" class="mt-3"></div>
                    </div>

                    <hr>

                    <!-- Estat√≠sticas -->
                    <div class="stats-section">
                        <h6><i class="fas fa-chart-bar me-2"></i>Estat√≠sticas da √Årvore</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1" id="total-pessoas-arvore">0</h6>
                                        <small>Pessoas</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1" id="total-relacionamentos-arvore">0</h6>
                                        <small>V√≠nculos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body py-2">
                                        <h6 class="mb-1" id="nos-expandidos">0</h6>
                                        <small>Expandidos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Instru√ß√µes de uso -->
                    <div class="instructions-section">
                        <h6><i class="fas fa-info-circle me-2"></i>Instru√ß√µes de Uso</h6>
                        <div class="alert alert-info py-2">
                            <small>
                                <strong>Intera√ß√µes na √Årvore:</strong><br>
                                ‚Ä¢ <strong>Clique simples:</strong> Menu de op√ß√µes<br>
                                ‚Ä¢ <strong>Duplo clique:</strong> Expandir/recolher v√≠nculos<br>
                                ‚Ä¢ <strong>Arrastar:</strong> Mover n√≥ pela tela<br>
                                ‚Ä¢ <strong>Scroll:</strong> Zoom in/out<br>
                                ‚Ä¢ <strong>Menu contextual:</strong> Personalizar cores e fotos
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- √Årea da √°rvore (direita) -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">√Årvore Geneal√≥gica Interativa</h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="toggleTelaCheia()" title="Expandir √°rvore para tela cheia">
                                <i class="fas fa-expand me-1"></i>Tela Cheia
                            </button>
                            <button class="btn btn-sm btn-success" onclick="analisarTodosOsDados()" title="Analisar TODOS os dados e criar relacionamentos autom√°ticos">
                                <i class="fas fa-brain me-1"></i>An√°lise Completa
                            </button>
                        </div>
                    </div>

                    <!-- Controles de layout e ferramentas -->
                    <div class="row mb-3">
                        <!-- Layouts -->
                        <div class="col-md-6">
                            <label class="form-label small"><i class="fas fa-sitemap me-1"></i>Layout da √Årvore:</label>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-sm btn-outline-primary active" data-layout="force" onclick="alterarLayoutArvore('force')">
                                    <i class="fas fa-atom me-1"></i>For√ßa
                                </button>
                                <button class="btn btn-sm btn-outline-primary" data-layout="hierarchical" onclick="alterarLayoutArvore('hierarchical')">
                                    <i class="fas fa-sitemap me-1"></i>√Årvore
                                </button>
                                <button class="btn btn-sm btn-outline-primary" data-layout="circular" onclick="alterarLayoutArvore('circular')">
                                    <i class="fas fa-circle-notch me-1"></i>Circular
                                </button>
                            </div>
                            <div class="btn-group w-100 mt-1" role="group">
                                <button class="btn btn-sm btn-outline-success" data-layout="radial" onclick="alterarLayoutArvore('radial')">
                                    <i class="fas fa-sun me-1"></i>Radial
                                </button>
                                <button class="btn btn-sm btn-outline-success" data-layout="grid" onclick="alterarLayoutArvore('grid')">
                                    <i class="fas fa-th me-1"></i>Grade
                                </button>
                                <button class="btn btn-sm btn-outline-success" data-layout="cluster" onclick="alterarLayoutArvore('cluster')">
                                    <i class="fas fa-layer-group me-1"></i>Grupos
                                </button>
                            </div>
                            <div class="btn-group w-100 mt-1" role="group">
                                <button class="btn btn-sm btn-outline-warning" data-layout="timeline" onclick="alterarLayoutArvore('timeline')">
                                    <i class="fas fa-timeline me-1"></i>Timeline
                                </button>
                                <button class="btn btn-sm btn-outline-warning" data-layout="spiral" onclick="alterarLayoutArvore('spiral')">
                                    <i class="fas fa-hurricane me-1"></i>Espiral
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-layout="free" onclick="alterarLayoutArvore('free')">
                                    <i class="fas fa-hand-paper me-1"></i>Livre
                                </button>
                            </div>
                        </div>

                        <!-- Zoom & Exportar -->
                        <div class="col-md-3">
                            <label class="form-label small"><i class="fas fa-search-plus me-1"></i>Zoom & Exportar:</label>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-sm btn-outline-info" id="zoom-in"><i class="fas fa-plus"></i></button>
                                <button class="btn btn-sm btn-outline-info" id="zoom-reset"><i class="fas fa-home"></i></button>
                                <button class="btn btn-sm btn-outline-info" id="zoom-out"><i class="fas fa-minus"></i></button>
                            </div>
                            <button class="btn btn-sm btn-success w-100 mt-1" id="exportar-arvore">
                                <i class="fas fa-download me-1"></i>Exportar
                            </button>
                        </div>

                        <!-- Organiza√ß√£o -->
                        <div class="col-md-3">
                            <label class="form-label small"><i class="fas fa-cogs me-1"></i>Organiza√ß√£o:</label>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-sm btn-outline-success" id="expandir-todos"><i class="fas fa-expand-arrows-alt"></i></button>
                                <button class="btn btn-sm btn-outline-warning" id="recolher-todos"><i class="fas fa-compress-arrows-alt"></i></button>
                                <button class="btn btn-sm btn-outline-secondary" id="reorganizar"><i class="fas fa-sync-alt"></i></button>
                            </div>
                        </div>

                        <!-- Espa√ßamento -->
                        <div class="col-md-3">
                            <label class="form-label small"><i class="fas fa-arrows-alt-h me-1"></i>Espa√ßamento:</label>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-info" id="diminuir-espaco"><i class="fas fa-compress-alt"></i></button>
                                <input type="range" class="form-range mx-2" id="controle-espacamento" min="50" max="300" value="150">
                                <button class="btn btn-sm btn-outline-info" id="aumentar-espaco"><i class="fas fa-expand-alt"></i></button>
                            </div>
                            <small class="text-muted d-block text-center mt-1"><span id="valor-espacamento">150</span>px</small>
                        </div>
                    </div>

                    <!-- Bot√µes de limpeza -->
                    <div class="d-flex justify-content-end">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-warning" onclick="limparConexoesAutomaticas()">
                                <i class="fas fa-eraser me-1"></i>Limpar Auto
                            </button>
                            <button class="btn btn-outline-danger" onclick="limparTodasConexoes()">
                                <i class="fas fa-trash me-1"></i>Limpar Todas
                            </button>
                            <button class="btn btn-outline-info" onclick="renderizarArvoreInterativa()">
                                <i class="fas fa-refresh me-1"></i>Atualizar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div id="arvore-container" style="height: 600px; border: 1px solid #ddd; border-radius: 5px;">
                        <!-- A √°rvore interativa ser√° renderizada aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ===== SISTEMA MODULAR REFATORADO ===== -->

<!-- 1. Sistema de Cache Inteligente -->
<script src="{% static 'core/js/utils/data-cache.js' %}"></script>

<!-- 2. M√≥dulos Especializados da √Årvore -->
<script src="{% static 'core/js/arvore/arvore-relacionamentos.js' %}"></script>
<script src="{% static 'core/js/arvore/arvore-busca.js' %}"></script>
<script src="{% static 'core/js/arvore/arvore-layouts.js' %}"></script>
<script src="{% static 'core/js/arvore/arvore-interface.js' %}"></script>

<!-- 3. N√∫cleo Unificado -->
<script src="{% static 'core/js/arvore/arvore-core.js' %}"></script>

<!-- 4. API Client para intera√ß√µes com backend -->
<script src="{% static 'core/js/api-client.js' %}"></script>

<script>
    // ===== FUN√á√ïES DE COMPATIBILIDADE =====
    
    // Busca inteligente na √°rvore
    function buscarPessoaNaArvore() {
        const campoBusca = document.getElementById('busca-arvore');
        if (campoBusca && window.BuscaInteligente) {
            window.BuscaInteligente.pesquisarEExibirPessoaNaArvore(campoBusca.value);
        }
    }
    
    // Busca por GOA espec√≠fica
    function buscarPorGOA() {
        const campoGoa = document.getElementById('busca-goa');
        if (campoGoa && window.BuscaInteligente) {
            window.BuscaInteligente.pesquisarEExibirPessoaNaArvore(campoGoa.value);
        }
    }
    
    // Buscar e expandir automaticamente
    function buscarEExpandirPorGOA() {
        const campoGoa = document.getElementById('busca-goa');
        if (campoGoa?.value && window.BuscaInteligente && window.RelacionamentoManager) {
            // Primeiro buscar
            window.BuscaInteligente.pesquisarEExibirPessoaNaArvore(campoGoa.value)
                .then(pessoaEncontrada => {
                    if (pessoaEncontrada) {
                        // Depois expandir automaticamente
                        return window.RelacionamentoManager.criarRelacionamentosAutomaticosFamilia(pessoaEncontrada.id);
                    }
                })
                .then(() => {
                    showNotification('üîç Busca e expans√£o autom√°tica conclu√≠da!', 'success');
                })
                .catch(error => {
                    console.error('Erro na busca e expans√£o:', error);
                    showNotification('‚ùå Erro na busca autom√°tica', 'error');
                });
        }
    }
    
    // Alterar layout da √°rvore
    function alterarLayoutArvore(layout) {
        if (window.ArvoreCore) {
            window.ArvoreCore.alterarLayoutArvore(layout);
        }
    }
    
    // An√°lise completa de dados
    async function analisarTodosOsDados() {
        if (window.RelacionamentoManager) {
            showNotification('üß† Iniciando an√°lise completa...', 'info');
            try {
                const stats = await window.RelacionamentoManager.criarRelacionamentosAutomaticosFamilia();
                showNotification(`‚úÖ An√°lise completa! ${stats.total} relacionamentos criados`, 'success');
                // Re-renderizar √°rvore
                if (window.ArvoreCore) {
                    await window.ArvoreCore.renderizarArvoreInterativa();
                }
            } catch (error) {
                console.error('Erro na an√°lise:', error);
                showNotification('‚ùå Erro na an√°lise completa', 'error');
            }
        }
    }
    
    // Tela cheia
    function toggleTelaCheia() {
        const container = document.getElementById('arvore-container');
        if (container) {
            if (container.requestFullscreen) {
                container.requestFullscreen();
            }
        }
    }
    
    // Limpeza de conex√µes
    function limparConexoesAutomaticas() {
        if (window.RelacionamentoManager) {
            window.RelacionamentoManager.limparRelacionamentosAutomaticos()
                .then(() => {
                    showNotification('üßπ Conex√µes autom√°ticas removidas', 'success');
                    if (window.ArvoreCore) {
                        window.ArvoreCore.renderizarArvoreInterativa();
                    }
                });
        }
    }
    
    function limparTodasConexoes() {
        if (confirm('‚ö†Ô∏è Deseja realmente limpar TODAS as conex√µes?')) {
            if (window.RelacionamentoManager) {
                window.RelacionamentoManager.limparTodosRelacionamentos()
                    .then(() => {
                        showNotification('üßπ Todas as conex√µes removidas', 'warning');
                        if (window.ArvoreCore) {
                            window.ArvoreCore.renderizarArvoreInterativa();
                        }
                    });
            }
        }
    }
    
    // Re-renderiza√ß√£o
    function renderizarArvoreInterativa() {
        if (window.ArvoreCore) {
            window.ArvoreCore.renderizarArvoreInterativa();
        }
    }
    
    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', () => {
        // Mostrar esta se√ß√£o quando acessada diretamente
        const section = document.getElementById('arvore');
        if (section) {
            section.style.display = 'block';
        }
        
        // Aguardar carregamento completo dos m√≥dulos
        setTimeout(() => {
            if (window.ArvoreCore) {
                console.log('üå≥ Inicializando sistema unificado...');
                inicializarArvoreInterativa();
            } else {
                console.error('‚ùå ArvoreCore n√£o foi carregado');
                showNotification('‚ùå Erro no carregamento do sistema', 'error');
            }
        }, 500);
        
        // Configurar controles de espa√ßamento
        const controleEspacamento = document.getElementById('controle-espacamento');
        const valorEspacamento = document.getElementById('valor-espacamento');
        
        if (controleEspacamento && valorEspacamento) {
            controleEspacamento.addEventListener('input', (e) => {
                valorEspacamento.textContent = e.target.value;
                // Aplicar espa√ßamento se o layout manager suportar
                if (window.LayoutManager) {
                    window.LayoutManager.configurarEspacamento(parseInt(e.target.value));
                    if (window.ArvoreCore) {
                        window.ArvoreCore.renderizarArvoreInterativa();
                    }
                }
            });
        }
        
        // Busca com Enter
        const campoBusca = document.getElementById('busca-arvore');
        if (campoBusca) {
            campoBusca.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    buscarPessoaNaArvore();
                }
            });
        }
        
        const campoGoa = document.getElementById('busca-goa');
        if (campoGoa) {
            campoGoa.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    buscarPorGOA();
                }
            });
        }
    });
</script>
{% endblock %}